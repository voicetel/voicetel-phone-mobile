<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>VoiceTel Phone v3.5</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family:
					-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					Oxygen, Ubuntu, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				display: flex;
				justify-content: center;
				align-items: center;
				padding: 20px;
			}

			.container {
				background: white;
				border-radius: 20px;
				box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
				max-width: 500px;
				width: 100%;
				overflow: hidden;
			}

			.header {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 30px;
				text-align: left;
				position: relative;
			}

			.header h1 {
				font-size: 28px;
				margin-bottom: 10px;
			}

			.status {
				display: inline-block;
				padding: 5px 15px;
				border-radius: 20px;
				background: rgba(255, 255, 255, 0.2);
				font-size: 14px;
				margin-top: 10px;
			}

			.status.registered {
				background: rgba(76, 175, 80, 0.3);
			}

			.header-buttons {
				position: absolute;
				top: 20px;
				right: 20px;
				display: flex;
				gap: 8px;
			}

			.header-toggle {
				background: rgba(255, 255, 255, 0.2);
				border: none;
				color: white;
				width: 40px;
				height: 40px;
				border-radius: 50%;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 20px;
				transition: all 0.3s;
			}

			.header-toggle:hover {
				background: rgba(255, 255, 255, 0.3);
				transform: rotate(90deg);
			}

			.header-toggle.active {
				background: rgba(255, 255, 255, 0.4);
			}

			.content {
				padding: 30px;
			}

			.section {
				margin-bottom: 25px;
			}

			.section.config-section {
				max-height: 0;
				overflow: hidden;
				transition:
					max-height 0.4s ease-out,
					margin-bottom 0.4s ease-out;
				margin-bottom: 0;
			}

			.section.config-section.visible {
				max-height: 1000px;
				margin-bottom: 25px;
			}

			.section.log-section {
				max-height: 0;
				overflow: hidden;
				transition:
					max-height 0.4s ease-out,
					margin-bottom 0.4s ease-out;
				margin-bottom: 0;
			}

			.section.log-section.visible {
				max-height: 800px;
				margin-bottom: 25px;
			}

			#historySection.visible {
				margin-bottom: 25px;
			}

			#historySection .log {
				padding: 20px;
				max-height: 260px;
				border-radius: 12px;
			}

			#historySection .log-entry {
				display: flex;
				justify-content: space-between;
				align-items: baseline;
				gap: 12px;
				padding: 10px 12px;
				margin-bottom: 8px;
				background: #fff;
				border-radius: 8px;
			}

			#historySection .log-entry strong {
				font-weight: 700;
				color: #333;
			}

			#historySection .log-entry small {
				color: #999;
			}

			#historySection .log-entry em {
				font-style: normal;
				opacity: 0.8;
			}

			#historySection .history-actions {
				display: flex;
				gap: 10px;
				margin-top: 12px;
			}

			.section.hideable {
				display: block;
				transition: opacity 0.3s ease-out;
			}

			.section.hideable.hidden {
				display: none;
			}

			.section h2 {
				font-size: 18px;
				color: #333;
				margin-bottom: 15px;
				padding-bottom: 8px;
				border-bottom: 2px solid #f0f0f0;
			}

			.form-group {
				margin-bottom: 15px;
			}

			.form-group label {
				display: block;
				margin-bottom: 5px;
				color: #666;
				font-size: 14px;
			}

			.form-group label small {
				font-weight: normal;
				display: block;
				margin-top: 2px;
			}

			.form-group input[type="checkbox"] {
				width: auto;
				margin-right: 8px;
			}

			.form-group input {
				width: 100%;
				padding: 10px;
				border: 2px solid #e0e0e0;
				border-radius: 8px;
				font-size: 14px;
				transition: border-color 0.3s;
			}

			.form-group input:focus {
				outline: none;
				border-color: #667eea;
			}

			.button-group {
				display: flex;
				gap: 10px;
				margin-top: 15px;
			}

			button {
				flex: 1;
				padding: 12px 20px;
				border: none;
				border-radius: 8px;
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s;
			}

			.btn-primary {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
			}

			.btn-primary:hover {
				transform: translateY(-2px);
				box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
			}

			.btn-success {
				background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
				color: white;
			}

			.btn-danger {
				background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
				color: white;
			}

			.btn-secondary {
				background: #f0f0f0;
				color: #333;
			}

			button:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}

			.call-controls {
				display: none;
				text-align: center;
				padding: 20px;
				background: #f8f8f8;
				border-radius: 12px;
				margin-top: 20px;
			}

			.call-controls.active {
				display: block;
			}

			.call-info {
				font-size: 16px;
				color: #666;
				margin-bottom: 15px;
			}

			.dialpad {
				display: grid;
				grid-template-columns: repeat(3, 1fr);
				gap: 10px;
				max-width: 250px;
				margin: 20px auto;
			}

			.dialpad button {
				aspect-ratio: 1;
				font-size: 20px;
				background: white;
				border: 2px solid #e0e0e0;
				color: #333;
			}

			.dialpad button:hover {
				background: #f0f0f0;
				transform: none;
				box-shadow: none;
			}

			#callNumber {
				text-align: center;
				font-size: 18px;
				margin-bottom: 10px;
				font-family: monospace;
			}

			.log {
				background: #f8f8f8;
				border-radius: 8px;
				padding: 15px;
				max-height: 150px;
				overflow-y: auto;
				font-family: monospace;
				font-size: 12px;
				color: #666;
			}

			.log-entry {
				margin-bottom: 5px;
				padding: 5px;
				background: white;
				border-radius: 4px;
			}

			.audio-container {
				display: none;
			}

			.incoming-call {
				display: none;
				background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
				color: white;
				padding: 20px;
				border-radius: 12px;
				margin-bottom: 20px;
				animation: pulse 1.5s infinite;
			}

			.incoming-call.active {
				display: block;
			}

			.incoming-caller {
				font-size: 20px;
				font-weight: bold;
				margin-bottom: 10px;
				text-align: center;
			}

			.incoming-number {
				font-size: 16px;
				margin-bottom: 15px;
				text-align: center;
				opacity: 0.9;
			}

			.incoming-buttons {
				display: flex;
				gap: 10px;
			}

			.btn-answer {
				background: white;
				color: #4caf50;
				flex: 1;
			}

			.btn-answer:hover {
				background: #f0f0f0;
			}

			.btn-decline {
				background: rgba(255, 255, 255, 0.2);
				color: white;
				flex: 1;
			}

			.btn-decline:hover {
				background: rgba(255, 255, 255, 0.3);
			}

			.encryption-info {
				background: #e8f4f8;
				border: 1px solid #b3d9e8;
				border-radius: 8px;
				padding: 10px;
				margin-top: 10px;
				font-size: 12px;
				color: #2c5aa0;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<div class="header-buttons">
					<button
						class="header-toggle active"
						onclick="showPhone()"
						title="Phone"
					>
						üìû
					</button>
					<button
						class="header-toggle"
						onclick="showHistory()"
						title="Call History"
					>
						üìú
					</button>
					<button
						class="header-toggle"
						onclick="showLog()"
						title="Event Log"
					>
						üìã
					</button>
					<button
						class="header-toggle"
						onclick="showSettings()"
						title="Settings"
					>
						‚öôÔ∏è
					</button>
				</div>
				<h1>VoiceTel</h1>
				<div id="status" class="status">Disconnected</div>
			</div>

			<div class="content">
				<div class="section hideable" id="registerSection">
					<div class="button-group">
						<button
							id="registerBtn"
							class="btn-primary"
							onclick="register()"
						>
							Register
						</button>
						<button
							id="unregisterBtn"
							class="btn-secondary"
							onclick="unregister()"
							disabled
						>
							Unregister
						</button>
					</div>
				</div>

				<div class="section config-section" id="configSection">
					<h2>SIP Configuration</h2>
					<input
						type="hidden"
						id="sipServer"
						value="wss://tls.voicetel.com:443"
					/>

					<div class="form-group">
						<label>
							Username
							<small style="color: #999"
								>Must be exactly 10 digits (your phone
								number)</small
							>
						</label>
						<input
							type="tel"
							id="username"
							placeholder="e.g. 5551234567"
							maxlength="10"
							pattern="[0-9]{10}"
							required
							inputmode="numeric"
						/>
						<small
							id="usernameError"
							style="
								color: #d32f2f;
								display: none;
								margin-top: 5px;
							"
						>
							Username must be exactly 10 numeric digits
						</small>
					</div>

					<div class="form-group">
						<label>Password</label>
						<input
							type="password"
							id="password"
							placeholder="password"
						/>
					</div>

					<div class="form-group">
						<label>Display Name</label>
						<input
							type="text"
							id="displayName"
							placeholder="Your Name"
						/>
					</div>

					<div class="form-group">
						<label>
							Caller ID Number
							<small style="color: #999"
								>Optional - North American format only (10
								digits). Will be combined with Display Name for
								outbound caller ID.</small
							>
						</label>
						<input
							type="tel"
							id="callerID"
							placeholder="e.g. 8005551234 or (800) 555-1234"
							maxlength="10"
							pattern="[2-9][0-9]{2}[2-9][0-9]{6}"
							inputmode="numeric"
						/>
						<small
							id="callerIDError"
							style="
								color: #d32f2f;
								display: none;
								margin-top: 5px;
							"
						>
							Please enter a valid 10-digit North American phone
							number
						</small>
					</div>

					<div
						class="form-group"
						style="
							background: #f8f8f8;
							padding: 15px;
							border-radius: 8px;
							margin-top: 20px;
						"
					>
						<label
							style="
								display: flex;
								align-items: center;
								cursor: pointer;
								color: #667eea;
								font-weight: 600;
							"
						>
							<input
								type="checkbox"
								id="saveCredentials"
								style="width: auto; margin-right: 8px"
							/>
							Save credentials securely
						</label>
						<small
							style="color: #999; display: block; margin-top: 8px"
						>
							üîí Credentials are encrypted locally with AES‚ÄëGCM (WebCrypto) and saved on this device only.</small>

						<label
							style="
								display: flex;
								align-items: center;
								cursor: pointer;
								color: #667eea;
								font-weight: 600;
								margin-top: 20px;
							"
						>
							<input
								type="checkbox"
								id="saveConfigApp"
								style="width: auto; margin-right: 8px"
							/>
							Save SIP configuration in app storage
						</label>
						<small
							style="color: #999; display: block; margin-top: 8px"
						>
							Stores your SIP settings alongside Call History
							using the same local app storage. Passwords are
							encrypted with your device fingerprint key.
						</small>

						<label
							class="checkbox-row"
							style="
								display: flex;
								align-items: center;
								cursor: pointer;
								color: #667eea;
								font-weight: 600;
								margin-top: 20px;
							"
						>
							<input type="checkbox" id="registerOnStartup" />
							<span>Register automatically on startup</span>
						</label>

						<div
							id="encryptionInfo"
							class="encryption-info"
							style="display: none"
						></div>

						<button
							class="btn-secondary"
							onclick="clearAllSaved()"
							style="
								margin-top: 10px;
								padding: 8px 16px;
								font-size: 12px;
							"
						>
							Clear All Saved Data
						</button>
					</div>
				</div>

				<div class="section hideable" id="callSection">
					<div id="incomingCall" class="incoming-call">
						<div
							style="
								text-align: center;
								font-size: 32px;
								margin-bottom: 10px;
							"
						>
							üìû
						</div>
						<div class="incoming-caller" id="incomingCallerName">
							Incoming Call
						</div>
						<div class="incoming-number" id="incomingCallerNumber">
							Unknown Number
						</div>
						<div class="incoming-buttons">
							<button class="btn-answer" onclick="answerCall()">
								‚úì Answer
							</button>
							<button class="btn-decline" onclick="declineCall()">
								‚úó Decline
							</button>
						</div>
						<div
							style="
								text-align: center;
								margin-top: 10px;
								font-size: 11px;
								opacity: 0.8;
							"
						>
							Press Enter to answer ‚Ä¢ Escape to decline
						</div>
					</div>

					<div class="form-group">
						<input
							type="text"
							id="callNumber"
							placeholder="Enter number to dial / DTMF during call"
							inputmode="numeric"
						/>
					</div>

					<div class="dialpad">
						<button onclick="appendNumber('1')">1</button>
						<button onclick="appendNumber('2')">2</button>
						<button onclick="appendNumber('3')">3</button>
						<button onclick="appendNumber('4')">4</button>
						<button onclick="appendNumber('5')">5</button>
						<button onclick="appendNumber('6')">6</button>
						<button onclick="appendNumber('7')">7</button>
						<button onclick="appendNumber('8')">8</button>
						<button onclick="appendNumber('9')">9</button>
						<button onclick="appendNumber('*')">*</button>
						<button onclick="appendNumber('0')">0</button>
						<button onclick="appendNumber('#')">#</button>
					</div>

					<div class="form-group" style="margin-top: 15px">
						<label
							style="
								display: flex;
								align-items: center;
								cursor: pointer;
							"
						>
							<input
								type="checkbox"
								id="hideCallerID"
								style="width: auto; margin-right: 8px"
							/>
							Hide Caller ID (Privacy)
						</label>
					</div>

					<div class="button-group">
						<button
							id="callBtn"
							class="btn-success"
							onclick="makeCall()"
							disabled
						>
							üìû Call
						</button>
						<button class="btn-secondary" onclick="clearNumber()">
							Clear
						</button>
					</div>

					<div id="callControls" class="call-controls">
						<div class="call-info">
							<div id="callStatus">Call in progress</div>
							<div id="callDuration">00:00</div>
						</div>
						<div id="ringingIndicator" class="ringing-indicator">
							üîî Ringing...
						</div>
						<div
							class="button-group"
							style="max-width: 300px; margin: 0 auto"
						>
							<button
								id="muteBtn"
								class="btn-secondary"
								onclick="toggleMute()"
							>
								Mute
							</button>
							<button
								id="hangupBtn"
								class="btn-danger"
								onclick="hangup()"
							>
								Hang Up
							</button>
						</div>
					</div>
				</div>

				<div class="section log-section" id="logSection">
					<h2>Event Log</h2>
					<div id="log" class="log"></div>

					<div
						style="
							text-align: center;
							margin-top: 10px;
							color: #999;
							font-size: 12px;
						"
					>
						WebSocket: wss://tls.voicetel.com:443 | SIP Domain:
						tls.voicetel.com
					</div>

					<details
						style="
							margin-top: 15px;
							padding: 10px;
							background: #f8f8f8;
							border-radius: 8px;
						"
					>
						<summary
							style="
								cursor: pointer;
								color: #667eea;
								font-weight: 600;
							"
						>
							‚ö†Ô∏è Troubleshooting Tips
						</summary>
						<div
							style="
								margin-top: 10px;
								font-size: 13px;
								color: #666;
								line-height: 1.6;
							"
						>
							<ul style="margin-left: 20px">
								<li>
									Ensure microphone permissions are granted
								</li>
								<li>
									Try using Chrome or Firefox (latest
									versions) or if using an application run it
									in in --no-sandbox mode.
								</li>
								<li>
									Check that your firewall allows WebRTC
									traffic
								</li>
								<li>Disable VPN if you're using one</li>
							</ul>
							<p style="margin-top: 10px">
								<strong>
									Need assistance? Contact the
									<a href="mailto:support@voicetel.com"
										>VoiceTel Support Team</a
									>
									for help.
								</strong>
							</p>
						</div>
					</details>
				</div>

				<div class="section log-section" id="historySection">
					<h2>Call History</h2>
					<div id="callHistory" class="log"></div>
					<div
						class="history-actions"
						style="display: flex; gap: 10px; margin-top: 12px"
					>
						<button class="btn-secondary" onclick="clearHistory()">
							Clear History
						</button>
						<button
							class="btn-secondary"
							onclick="renderCallHistory()"
						>
							Refresh
						</button>
					</div>
				</div>
			</div>

			<div class="audio-container">
				<audio id="remoteAudio" autoplay></audio>
				<audio id="localAudio" autoplay muted></audio>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/sip.js@0.15.11/dist/sip.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
		<script>
			// Constants
			const INCOMING_CALL_TIMEOUT_MS = 30000;
			const DTMF_DURATION_MS = 250;
			const DTMF_INTERTONE_GAP_MS = 100;
			const SIP_REGISTRATION_EXPIRES_SEC = 300;
			const COOKIE_EXPIRY_DAYS = 30;
			const USERNAME_LENGTH = 10;

			// Username validation function
			function isValidUsername(username) {
				return username && /^\d{10}$/.test(username) && username.length === USERNAME_LENGTH;
			

}

			// Cookie storage implementation with browser fingerprint-based encryption
			// Wait for DOM and library to load
			window.addEventListener("DOMContentLoaded", function () {
				if (typeof SIP === "undefined") {
					console.error("SIP.js library failed to load");
					log(
						"Error: SIP.js library not loaded. Please refresh the page.",
					);
					alert(
						"SIP.js library failed to load. Please check your internet connection and refresh the page.",
					);
				} else {
					console.log("SIP.js version:", SIP.version || "unknown");
					log("VoiceTel RTC Phone v3.5 ready");
					log("Smart DTMF with automatic RFC 2833/SIP INFO fallback");
					log("SIP.js " + (SIP.version || "0.15.x") + " loaded");
					log("Server: tls.voicetel.com (wss://443)");
					log(
						"Using device fingerprint for encryption (no external calls)",
					);
				}

				SecureStore.loadCredentials();

				// Global keyboard shortcuts for incoming calls (register once)
				document.addEventListener("keydown", function (e) {
					if (incomingSession) {
						if (e.key === "Enter" || e.key === " ") {
							e.preventDefault();
							answerCall();
						} else if (e.key === "Escape") {
							e.preventDefault();
							declineCall();
						}
					}
				});

				document
					.getElementById("username")
					.addEventListener("input", function (e) {
						const value = e.target.value.replace(/\D/g, "");
						e.target.value = value.substring(0, USERNAME_LENGTH);

						const errorEl =
							document.getElementById("usernameError");
						if (value && value.length !== USERNAME_LENGTH) {
							errorEl.style.display = "block";
						} else {
							errorEl.style.display = "none";
						}
					});

				document
					.getElementById("callerID")
					.addEventListener("input", function (e) {
						const value = e.target.value.replace(/\D/g, "");
						e.target.value = value.substring(0, USERNAME_LENGTH);

						const errorEl =
							document.getElementById("callerIDError");
						if (value && !validateNorthAmericanNumber(value)) {
							errorEl.style.display = "block";
						} else {
							errorEl.style.display = "none";
						}
					});

				document
					.getElementById("username")
					.addEventListener("change", function () {
						if (
							document.getElementById("saveCredentials").checked
						) {
							SecureStore.saveCredentials();
						}
					});

				document
					.getElementById("password")
					.addEventListener("change", function () {
						if (
							document.getElementById("saveCredentials").checked
						) {
							SecureStore.saveCredentials();
						}
					});

				document
					.getElementById("displayName")
					.addEventListener("change", function () {
						if (
							document.getElementById("saveCredentials").checked
						) {
							SecureStore.saveCredentials();
						}
					});

				document
					.getElementById("callerID")
					.addEventListener("change", function () {
						if (
							document.getElementById("saveCredentials").checked
						) {
							SecureStore.saveCredentials();
						}
					});

				document
					.getElementById("saveCredentials")
					.addEventListener("change", function () {
						SecureStore.saveCredentials();
					});
			});

			let registeredUsername = null;

			let userAgent = null;
			let currentSession = null;
			let incomingSession = null;
			let incomingCallTimeout = null;
			let isRegistered = false;
			let isMuted = false;
			let callTimer = null;
			let callStartTime = null;
			let ringingAudio = null;

			function validateNorthAmericanNumber(number) {
				const cleaned = number.replace(/\D/g, "");

				if (cleaned.length !== USERNAME_LENGTH) return false;

				const npaFirstDigit = parseInt(cleaned[0]);
				const nxxFirstDigit = parseInt(cleaned[3]);

				return (
					npaFirstDigit >= 2 &&
					npaFirstDigit <= 9 &&
					nxxFirstDigit >= 2 &&
					nxxFirstDigit <= 9
				);
			}

			function createRingingTone() {
				const audioContext = new (window.AudioContext ||
					window.webkitAudioContext)();

				const oscillator1 = audioContext.createOscillator();
				const oscillator2 = audioContext.createOscillator();
				const gainNode = audioContext.createGain();

				oscillator1.frequency.value = 440;
				oscillator2.frequency.value = 480;
				oscillator1.type = "sine";
				oscillator2.type = "sine";

				gainNode.gain.setValueAtTime(0, audioContext.currentTime);

				const ringPattern = () => {
					const now = audioContext.currentTime;
					gainNode.gain.setValueAtTime(0.1, now);
					gainNode.gain.setValueAtTime(0.1, now + 2);
					gainNode.gain.setValueAtTime(0, now + 2.01);
					gainNode.gain.setValueAtTime(0, now + 6);
				};

				oscillator1.connect(gainNode);
				oscillator2.connect(gainNode);
				gainNode.connect(audioContext.destination);

				oscillator1.start();
				oscillator2.start();

				ringPattern();
				const ringInterval = setInterval(ringPattern, 6000);

				return {
					stop: () => {
						clearInterval(ringInterval);
						gainNode.gain.setValueAtTime(
							0,
							audioContext.currentTime,
						);
						setTimeout(() => {
							oscillator1.stop();
							oscillator2.stop();
							audioContext.close();
						}, 100);
					},
				};
			}

			function startRinging() {
				document.getElementById("ringingIndicator").style.display =
					"block";
				document.getElementById("callStatus").textContent =
					"Ringing...";

				try {
					ringingAudio = createRingingTone();
				} catch (e) {
					log("Could not generate ringing tone: " + e.message);
				}
			}

			function stopRinging() {
				document.getElementById("ringingIndicator").style.display =
					"none";
				document.getElementById("callStatus").textContent =
					"Call in progress";

				if (ringingAudio) {
					ringingAudio.stop();
					ringingAudio = null;
				}
			}

			function log(message) {
				const logDiv = document.getElementById("log");
				const entry = document.createElement("div");
				entry.className = "log-entry";
				const timestamp = new Date().toLocaleTimeString();
				entry.textContent = `[${timestamp}] ${message}`;
				logDiv.insertBefore(entry, logDiv.firstChild);

				while (logDiv.children.length > 10) {
					logDiv.removeChild(logDiv.lastChild);
				}
			}

			function updateStatus(text, registered = false) {
				const statusEl = document.getElementById("status");
				statusEl.textContent = text;
				if (registered) {
					statusEl.classList.add("registered");
				} else {
					statusEl.classList.remove("registered");
				}
			}

			function register() {
				if (typeof SIP === "undefined") {
					alert(
						"SIP.js library is not loaded. Please refresh the page.",
					);
					log("Error: SIP.js library not available");
					return;
				

}

				const server = document.getElementById("sipServer").value;
				const username = document.getElementById("username").value;
				const password = document.getElementById("password").value;
				const displayName =
					document.getElementById("displayName").value || username;
				const callerID = document.getElementById("callerID").value;

				if (!server || !username || !password) {
					alert("Please fill in all required fields");
					return;
				}

				if (!isValidUsername(username)) {
					alert("Username must be exactly 10 numeric digits");
					document.getElementById("usernameError").style.display =
						"block";
					return;
				}

				registeredUsername = username;

				try {
					log("Starting registration...");
					log("Connecting to VoiceTel server (tls.voicetel.com)...");
					log("SIP.js version: " + (SIP.version || "unknown"));
					log("SIP REGISTER sent");

					const uri = `sip:${username}@tls.voicetel.com`;

					const transportOptions = {
						wsServers: [server],
						traceSip: true,
						wsServerMaxReconnectionAttempts: 5,
						wsServerReconnectionTimeout: 4,
					};

					const userAgentOptions = {
						uri: uri,
						transportOptions: transportOptions,
						authorizationUser: username,
						password: password,
						displayName: displayName,
						register: true,
						registerOptions: {
							registrar: `sip:tls.voicetel.com`,
							expires: SIP_REGISTRATION_EXPIRES_SEC,
						},
						sessionDescriptionHandlerFactoryOptions: {
							constraints: {
								audio: true,
								video: false,
							},
							peerConnectionOptions: {
								rtcConfiguration: {
									iceServers: [
										{
											urls: "stun:stun.l.google.com:19302",
										},
										{
											urls: "stun:stun1.l.google.com:19302",
										},
									],
								},
							},
						},
						hackWssInTransport: false,
						hackIpInContact: true,
						dtmfType: "rtp",
					};

					userAgent = new SIP.UA(userAgentOptions);

					userAgent.on("registered", () => {
						isRegistered = true;
						updateStatus("Registered", true);
						log("Successfully registered");
						log("SIP/2.0 200 OK");

						document.getElementById("registerBtn").disabled = true;
						document.getElementById("unregisterBtn").disabled =
							false;
						document.getElementById("callBtn").disabled = false;

						if (
							"Notification" in window &&
							Notification.permission === "default"
						) {
							Notification.requestPermission().then(
								(permission) => {
									if (permission === "granted") {
										log(
											"Desktop notifications enabled for incoming calls",
										);
									}
								},
							);
						}
					});

					userAgent.on("registrationFailed", (response, cause) => {
						if (
							response &&
							response.status_code &&
							response.reason_phrase
						) {
							log(
								`SIP/2.0 ${response.status_code} ${response.reason_phrase}`,
							);
						}
						log(`Registration failed: ${cause}`);
						updateStatus("Registration Failed");
					});

					userAgent.on("unregistered", () => {
						log("SIP/2.0 200 OK (Unregistered)");
					});

					userAgent.on("invite", (session) => {
						const callerInfo =
							session.remoteIdentity.displayName ||
							session.remoteIdentity.uri.user;
						log(`Incoming call from ${callerInfo}`);

						if (
							"Notification" in window &&
							Notification.permission === "granted"
						) {
							new Notification("VoiceTel RTC Phone", {
								body: `Incoming call from ${callerInfo}`,
								icon: "üìû",
								requireInteraction: true,
							});
						}

						handleIncomingCall(session);
					});

					userAgent.start();
				} catch (error) {
					log(`Registration failed: ${error.message}`);
					updateStatus("Registration Failed");
					console.error(error);
				}
			}

			function unregister() {
				try {
					if (userAgent) {
						userAgent.unregister();
						userAgent.stop();
					

}

					isRegistered = false;
					registeredUsername = null;
					updateStatus("Disconnected");
					log("Unregistered successfully");
					log("SIP REGISTER (Expires: 0)");

					document.getElementById("registerBtn").disabled = false;
					document.getElementById("unregisterBtn").disabled = true;
					document.getElementById("callBtn").disabled = true;
				} catch (error) {
					log(`Unregister failed: ${error.message}`);
					console.error(error);
				}
			}

			function makeCall() {
				let number = document.getElementById("callNumber").value;

				const originalNumber = number;
				number = number.replace(/\D/g, "");

				if (originalNumber !== number && originalNumber.length > 0) {
					log(`Sanitized number: "${originalNumber}" ‚Üí "${number}"`);
				}

				if (!number) {
					alert("Please enter a number to call");
					return;
				}

				if (!isRegistered || !userAgent) {
					alert("Please register first");
					return;
				}

				if (incomingSession) {
					alert("Please answer or decline the incoming call first");
					return;
				}

				const callerID = document
					.getElementById("callerID")
					.value.replace(/\D/g, "");
				if (callerID && !validateNorthAmericanNumber(callerID)) {
					alert(
						"Please enter a valid 10-digit North American phone number for Caller ID",
					);
					document.getElementById("callerIDError").style.display =
						"block";
					return;
				}

				try {
					const displayName =
						document.getElementById("displayName").value ||
						registeredUsername;
					const hideCallerID =
						document.getElementById("hideCallerID").checked;

					const domain = "tls.voicetel.com";
					const uri = `sip:${number}@${domain}`;

					const options = {
						sessionDescriptionHandlerOptions: {
							constraints: {
								audio: true,
								video: false,
							},
						},
					};

					options.extraHeaders = [];

					let pAssertedIdentity;

					if (callerID && validateNorthAmericanNumber(callerID)) {
						const formattedNumber = "+1" + callerID;
						pAssertedIdentity = `"${displayName}" <sip:${formattedNumber}@tls.voicetel.com>`;
						log(
							`Setting caller ID: ${displayName} ${formattedNumber}`,
						);
					} else {
						pAssertedIdentity = `"${displayName}" <sip:${registeredUsername}@tls.voicetel.com>`;
						log(
							`Using default caller ID: ${displayName} ${registeredUsername}`,
						);
					}

					options.extraHeaders.push(
						"P-Asserted-Identity: " + pAssertedIdentity,
					);
					options.extraHeaders.push(
						"P-Preferred-Identity: " + pAssertedIdentity,
					);

					if (hideCallerID) {
						options.extraHeaders.push("Privacy: id");
						log("Caller ID privacy enabled");
					} else {
						options.extraHeaders.push("Privacy: none");
					}

					currentSession = userAgent.invite(uri, options);

					let sessionRingingStarted = false;

					if (currentSession.request) {
						const callId = currentSession.request.callId;

						const messageHandler = function (e) {
							if (e && e.data && e.data.includes(callId)) {
								const lines = e.data.split("\r\n");
								for (let line of lines) {
									if (line.startsWith("SIP/2.0")) {
										log(line);
										if (
											!sessionRingingStarted &&
											(line.includes("180 Ringing") ||
												line.includes(
													"183 Session Progress",
												))
										) {
											startRinging();
											sessionRingingStarted = true;
										}
										if (
											sessionRingingStarted &&
											line.includes("200 OK")
										) {
											stopRinging();
											sessionRingingStarted = false;
										}
										break;
									}
								}
							}
						};

						if (userAgent.transport && userAgent.transport.ws) {
							userAgent.transport.ws.addEventListener(
								"message",
								messageHandler,
							);

							currentSession.on("terminated", () => {
								if (sessionRingingStarted) {
									stopRinging();
									sessionRingingStarted = false;
								}
								userAgent.transport.ws.removeEventListener(
									"message",
									messageHandler,
								);
							});
							currentSession.on("failed", () => {
								if (sessionRingingStarted) {
									stopRinging();
									sessionRingingStarted = false;
								}
								userAgent.transport.ws.removeEventListener(
									"message",
									messageHandler,
								);
							});
						}
					}

					setupSessionHandlers(currentSession);

					log(`Calling ${number}...`);
					log("SIP INVITE sent");
					showCallControls();
				} catch (error) {
					log(`Call failed: ${error.message}`);
					console.error(error);
				}
			}

			function handleIncomingCall(session) {
				window.__incomingRaw = null;
				window.__incomingDisplay = null;
				if (currentSession) {
					log("Auto-rejecting incoming call - already in a call");
					session.reject();
					log("SIP/2.0 486 Busy Here");
					return;
				}

				incomingSession = session;

				log("SIP INVITE received");

				const callerUri =
					session.remoteIdentity &&
					session.remoteIdentity.uri &&
					session.remoteIdentity.uri.user
						? session.remoteIdentity.uri.user
						: "Unknown";
				window.__incomingRaw = callerUri;
				const callerName =
					session.remoteIdentity.displayName || "Unknown";

				let formattedNumber = callerUri;
				if (/^\d{10}$/.test(callerUri)) {
					formattedNumber = `(${callerUri.slice(0, 3)}) ${callerUri.slice(3, 6)}-${callerUri.slice(6)}`;
				} else if (/^\+1\d{10}$/.test(callerUri)) {
					const num = callerUri.slice(2);
					formattedNumber = `+1 (${num.slice(0, 3)}) ${num.slice(3, 6)}-${num.slice(6)}`;
				}

				document.getElementById("incomingCallerName").textContent =
					callerName;
				document.getElementById("incomingCallerNumber").textContent =
					formattedNumber;
				window.__incomingDisplay = formattedNumber;

				document.getElementById("incomingCall").classList.add("active");

				startRinging();
				log("SIP/2.0 180 Ringing");

				log(`Incoming call from ${callerName} ${formattedNumber}`);
				log("Press Enter to answer or Escape to decline");

				incomingCallTimeout = setTimeout(() => {
					if (incomingSession) {
						log("Auto-declining unanswered call after 30 seconds");
						declineCall();
					}
				}, INCOMING_CALL_TIMEOUT_MS);

				setupIncomingSessionHandlers(session);
			}

			function setupIncomingSessionHandlers(session) {
				session.on("terminated", () => {
					if (incomingCallTimeout) {
						clearTimeout(incomingCallTimeout);
						incomingCallTimeout = null;
					}
					hideIncomingCallUI();
					stopRinging();
					log("Incoming call ended by caller");
					incomingSession = null;
				});

				session.on("failed", () => {
					if (incomingCallTimeout) {
						clearTimeout(incomingCallTimeout);
						incomingCallTimeout = null;
					}
					hideIncomingCallUI();
					stopRinging();
					log("Incoming call failed");
					incomingSession = null;
				});

				session.on("rejected", () => {
					if (incomingCallTimeout) {
						clearTimeout(incomingCallTimeout);
						incomingCallTimeout = null;
					}
					hideIncomingCallUI();
					stopRinging();
					log("Incoming call was rejected");
					incomingSession = null;
				});
			}

			function answerCall() {
				if (!incomingSession) {
					log("No incoming call to answer");
					return;
				}

				if (incomingCallTimeout) {
					clearTimeout(incomingCallTimeout);
					incomingCallTimeout = null;
				}

				currentSession = incomingSession;
				incomingSession = null;

				hideIncomingCallUI();

				setupSessionHandlers(currentSession);

				currentSession.accept();

				stopRinging();
				showCallControls();
				log("Call answered");
				log("SIP/2.0 200 OK");
			}

			function declineCall() {
				if (!incomingSession) {
					log("No incoming call to decline");
					return;
				}

				if (incomingCallTimeout) {
					clearTimeout(incomingCallTimeout);
					incomingCallTimeout = null;
				}

				incomingSession.reject();
				hideIncomingCallUI();
				stopRinging();
				log("Call declined");
				log("SIP/2.0 603 Decline");
				incomingSession = null;
			}

			function hideIncomingCallUI() {
				document
					.getElementById("incomingCall")
					.classList.remove("active");
				document.getElementById("incomingCallerName").textContent =
					"Incoming Call";
				document.getElementById("incomingCallerNumber").textContent =
					"Unknown Number";
			}

			function setupSessionHandlers(session) {
				let ringingStarted = false;

				if (session.on) {
					session.on("response", (response) => {
						if (
							response &&
							response.status_code &&
							response.reason_phrase
						) {
							log(
								`SIP/2.0 ${response.status_code} ${response.reason_phrase}`,
							);

							if (
								!ringingStarted &&
								(response.status_code === 180 ||
									response.status_code === 183)
							) {
								startRinging();
								ringingStarted = true;
							}

							if (response.status_code === 200) {
								if (ringingStarted) {
									stopRinging();
									ringingStarted = false;
								}
							}
						}
					});
				}

				session.on("progress", (response) => {
					if (
						response &&
						response.status_code &&
						response.reason_phrase
					) {
						log(
							`SIP/2.0 ${response.status_code} ${response.reason_phrase}`,
						);

						if (
							!ringingStarted &&
							(response.status_code === 180 ||
								response.status_code === 183)
						) {
							startRinging();
							ringingStarted = true;
						}
					}
				});

				session.on("terminated", (message, cause) => {
					if (ringingStarted) {
						stopRinging();
						ringingStarted = false;
					}
					log("Call ended" + (cause ? ": " + cause : ""));
					endCall();
				});

				session.on("failed", (response, cause) => {
					if (
						response &&
						response.status_code &&
						response.reason_phrase
					) {
						log(
							`SIP/2.0 ${response.status_code} ${response.reason_phrase}`,
						);
					}

					if (ringingStarted) {
						stopRinging();
						ringingStarted = false;
					}

					if (
						cause &&
						cause.includes("SESSION_DESCRIPTION_HANDLER_ERROR")
					) {
						log(
							"‚ö†Ô∏è Media negotiation failed - incompatible media format",
						);
						log(
							"Server sent RTP/AVP (non-secure) but browser requires DTLS-SRTP",
						);
						log(
							'Missing required "fingerprint" attribute in server SDP',
						);
						alert(
							"Call failed: Media format incompatibility.\n\nTechnical details:\n- VoiceTel (tls.voicetel.com) sent non-secure RTP (RTP/AVP)\n- Browser requires secure media (DTLS-SRTP)\n- Missing fingerprint attribute for DTLS\n\nSolution:\nContact VoiceTel support and request:\n1. Enable WebRTC support on tls.voicetel.com\n2. Configure DTLS-SRTP for secure media\n3. Use a WebRTC-compatible media gateway",
						);
					} else {
						log("Call failed: " + (cause || "Unknown error"));
					}
					endCall();
				});

				session.on("rejected", (response, cause) => {
					if (
						response &&
						response.status_code &&
						response.reason_phrase
					) {
						log(
							`SIP/2.0 ${response.status_code} ${response.reason_phrase}`,
						);
					}
					log("Call rejected" + (cause ? ": " + cause : ""));
					if (ringingStarted) {
						stopRinging();
						ringingStarted = false;
					}
					endCall();
				});

				session.on("bye", (request) => {
					log("SIP BYE received");
					log("Call ended by remote");
					if (ringingStarted) {
						stopRinging();
						ringingStarted = false;
					}
					endCall();
				});

				session.on("accepted", (response) => {
					if (
						response &&
						response.status_code &&
						response.reason_phrase
					) {
						log(
							`SIP/2.0 ${response.status_code} ${response.reason_phrase}`,
						);
					}

					if (ringingStarted) {
						stopRinging();
						ringingStarted = false;
					}

					log("Call connected");

					if (
						currentSession &&
						currentSession.sessionDescriptionHandler &&
						currentSession.sessionDescriptionHandler.peerConnection
					) {
						const pc =
							currentSession.sessionDescriptionHandler
								.peerConnection;
						const remoteDesc = pc.remoteDescription;
						if (remoteDesc && remoteDesc.sdp) {
							if (remoteDesc.sdp.includes("telephone-event")) {
								log("Remote supports RFC 2833 telephone-event");
							} else {
								log(
									"‚ö†Ô∏è Remote does NOT support telephone-event - will use SIP INFO for DTMF",
								);
							}
						}
					}

					document.getElementById("callNumber").value = "";
					document.getElementById("callNumber").placeholder =
						"Type or press dialpad for DTMF";
					document.getElementById("callNumber").focus();

					startCallTimer();

					try {
						const pc =
							session.sessionDescriptionHandler.peerConnection;
						const remoteStream = new MediaStream();
						pc.getReceivers().forEach((receiver) => {
							if (receiver.track) {
								remoteStream.addTrack(receiver.track);
							}
						});

						const remoteAudio =
							document.getElementById("remoteAudio");
						remoteAudio.srcObject = remoteStream;
					} catch (e) {
						log("Error setting up audio: " + e.message);
					}
				});

				session.on("referRequestRejected", (response) => {
					if (
						response &&
						response.status_code &&
						response.reason_phrase
					) {
						log(
							`SIP/2.0 ${response.status_code} ${response.reason_phrase}`,
						);
					}
				});

				session.on("trackAdded", () => {
					try {
						const pc =
							session.sessionDescriptionHandler.peerConnection;
						const remoteStream = new MediaStream();
						pc.getReceivers().forEach((receiver) => {
							if (receiver.track) {
								remoteStream.addTrack(receiver.track);
							}
						});

						const remoteAudio =
							document.getElementById("remoteAudio");
						remoteAudio.srcObject = remoteStream;
					} catch (e) {
						log("Error handling track: " + e.message);
					}
				});
			}

			function hangup() {
				stopRinging();
				if (currentSession) {
					if (currentSession.hasAnswer) {
						currentSession.bye();
						log("SIP BYE sent");
					} else {
						currentSession.cancel();
						log("SIP CANCEL sent");
					}
					log("Hanging up...");
				}
			}

			function toggleMute() {
				if (
					!currentSession ||
					!currentSession.sessionDescriptionHandler
				)
					return;

				const pc =
					currentSession.sessionDescriptionHandler.peerConnection;
				const senders = pc.getSenders();

				senders.forEach((sender) => {
					if (sender.track && sender.track.kind === "audio") {
						sender.track.enabled = isMuted;
					}
				});

				isMuted = !isMuted;
				document.getElementById("muteBtn").textContent = isMuted
					? "Unmute"
					: "Mute";
				log(isMuted ? "Muted" : "Unmuted");
			}

			function showCallControls() {
				document.getElementById("callControls").classList.add("active");
				document.getElementById("callBtn").disabled = true;
			}

			function hideCallControls() {
				document
					.getElementById("callControls")
					.classList.remove("active");
				document.getElementById("callBtn").disabled = false;
				stopCallTimer();
			}

			function endCall() {
				currentSession = null;
				hideCallControls();
				stopRinging();
				isMuted = false;
				document.getElementById("muteBtn").textContent = "Mute";
				document.getElementById("callStatus").textContent =
					"Call in progress";

				document.getElementById("callNumber").placeholder =
					"Enter number (any format - will be cleaned)";
			}

			function startCallTimer() {
				callStartTime = Date.now();
				callTimer = setInterval(updateCallDuration, 1000);
			}

			function stopCallTimer() {
				if (callTimer) {
					clearInterval(callTimer);
					callTimer = null;
				}
				document.getElementById("callDuration").textContent = "00:00";
			}

			function updateCallDuration() {
				if (!callStartTime) return;

				const duration = Math.floor(
					(Date.now() - callStartTime) / 1000,
				);
				const minutes = Math.floor(duration / 60);
				const seconds = duration % 60;

				document.getElementById("callDuration").textContent =
					`${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
			}

			function appendNumber(num) {
				const input = document.getElementById("callNumber");

				if (currentSession) {
					const isEstablished =
						currentSession.dialog ||
						(currentSession.sessionDescriptionHandler &&
							currentSession.sessionDescriptionHandler
								.peerConnection);

					if (isEstablished) {
						if (sendDTMF(num)) {
							input.value = input.value + num;
						}
						return;
					}
				}

				input.value = input.value + num;
			}

			function clearNumber() {
				document.getElementById("callNumber").value = "";
			}

			function sendDTMF(digit) {
				if (!currentSession && !__answeredIncoming) {
					log("No active session for DTMF");
					return false;
				}

				const isEstablished =
					currentSession.dialog ||
					(currentSession.sessionDescriptionHandler &&
						currentSession.sessionDescriptionHandler
							.peerConnection);

				if (!isEstablished) {
					log("Call not fully established for DTMF");
					return false;
				}

				try {
					const options = {
						duration: DTMF_DURATION_MS,
						interToneGap: DTMF_INTERTONE_GAP_MS,
					};

					currentSession.dtmf(digit, options);
					log(`DTMF sent: ${digit} (${DTMF_DURATION_MS}ms duration)`);

					return true;
				} catch (error) {
					log(`DTMF failed: ${error.message}`);
					console.error("DTMF error:", error);
					return false;
				}
			}

			window.addEventListener("beforeunload", () => {
				stopRinging();
				if (incomingCallTimeout) {
					clearTimeout(incomingCallTimeout);
				}
				if (incomingSession) {
					try {
						incomingSession.reject();
					} catch (e) {}
				}
				if (currentSession) {
					try {
						currentSession.bye();
					} catch (e) {}
				}
				if (userAgent) {
					userAgent.stop();
				}
			});
		</script>
		<script>
			// === Unified view toggler ===
			function setView(view) {
				const registerSection =
					document.getElementById("registerSection");
				const callSection = document.getElementById("callSection");
				const configSection = document.getElementById("configSection");
				const logSection = document.getElementById("logSection");
				const historySection =
					document.getElementById("historySection");
				const buttons = document.querySelectorAll(".header-toggle");

				// Reset all
				registerSection.classList.add("hidden");
				callSection.classList.add("hidden");
				configSection.classList.remove("visible");
				logSection.classList.remove("visible");
				if (historySection) historySection.classList.remove("visible");

				// Show target
				if (view === "phone") {
					registerSection.classList.remove("hidden");
					callSection.classList.remove("hidden");
				} else if (view === "settings") {
					configSection.classList.add("visible");
				} else if (view === "log") {
					logSection.classList.add("visible");
				} else if (view === "history") {
					if (historySection) historySection.classList.add("visible");
					if (typeof renderCallHistory === "function")
						renderCallHistory();
				}

				// Header active
				buttons.forEach((b) => b.classList.remove("active"));
				const title =
					view === "phone"
						? "Phone"
						: view === "settings"
							? "Settings"
							: view === "log"
								? "Event Log"
								: "Call History";
				const btn = document.querySelector(
					`.header-toggle[title="${title}"]`,
				);
				if (btn) btn.classList.add("active");
			}

			// Bind public handlers
			window.showPhone = function () {
				setView("phone");
			};
			window.showLog = function () {
				setView("log");
			};
			window.showSettings = function () {
				setView("settings");
			};
			window.showHistory = function () {
				setView("history");
			};

			// Ensure history starts hidden
			window.addEventListener("DOMContentLoaded", () => {
				const historySection =
					document.getElementById("historySection");
				if (historySection) historySection.classList.remove("visible");
			});

			// === Call History using LocalForage ===
			try {
				localforage.config({
					name: "VoiceTel",
					storeName: "callHistory",
				});
			} catch (e) {
				console.error(e);
			}

			async function addCallToHistory(type, number, duration) {
				try {
					const entry = {
						type,
						number,
						duration,
						timestamp: new Date().toISOString(),
					};
					const list = (await localforage.getItem("history")) || [];
					list.unshift(entry);
					await localforage.setItem("history", list);
				} catch (e) {
					console.error("history save failed", e);
				}
			}

			function fmt(iso) {
				try {
					return new Date(iso).toLocaleString();
				} catch {
					return iso;
				}
			}

			async function renderCallHistory() {
				const el = document.getElementById("callHistory");
				if (!el) return;
				const list = (await localforage.getItem("history")) || [];
				el.innerHTML = "";
				if (list.length === 0) {
					el.innerHTML =
						"<div style='text-align:center;color:#999'>No call history yet</div>";
					return;
				}
				for (const item of list) {
					let icon = "‚õî";
					if (item.type === "incoming") icon = "‚¨áÔ∏è";
					else if (item.type === "outgoing") icon = "‚¨ÜÔ∏è";
					const row = document.createElement("div");
					row.className = "log-entry";
					row.innerHTML = `${icon} <a href="#" class="history-call" onclick="return redial('${item.number}')"><strong>${item.number}</strong></a><br><small>${fmt(item.timestamp)}</small> ‚Ä¢ <em>${item.duration}</em>`;
					el.appendChild(row);
				}
			}

			async function clearHistory() {
				await localforage.removeItem("history");
				renderCallHistory();
			}

			// --- Hook into lifecycle ---
			let __callDirection = null;
			let __answeredIncoming = false;
			const __orig_makeCall = window.makeCall;
			window.makeCall = function () {
				__callDirection = "outgoing";
				return __orig_makeCall.apply(this, arguments);
			};

			const __orig_answerCall = window.answerCall;
			window.answerCall = function () {
				__callDirection = "incoming";
				__answeredIncoming = true;
				return __orig_answerCall.apply(this, arguments);
			};

			const __orig_declineCall = window.declineCall;
			window.declineCall = function () {
				try {
					const num =
						window.__incomingRaw &&
						window.__incomingRaw !== "Unknown"
							? window.__incomingRaw
							: window.__incomingDisplay ||
								document.getElementById("incomingCallerNumber")
									.textContent ||
								"Unknown";
					addCallToHistory("missed", num, "00:00");
				} catch (e) {}
				return __orig_declineCall.apply(this, arguments);
			};

			const __orig_endCall = window.endCall;
			window.endCall = function () {
				try {
					if (__callDirection === "outgoing") {
						const toNum = (
							document.getElementById("callNumber").value || ""
						).trim();
						const num =
							toNum ||
							(currentSession &&
								currentSession.request &&
								currentSession.request.to &&
								currentSession.request.to.uri &&
								currentSession.request.to.uri.user) ||
							"Unknown";
						addCallToHistory(
							"outgoing",
							num,
							document.getElementById("callDuration")
								.textContent || "00:00",
						);
					} else if (__callDirection === "incoming") {
						const num =
							window.__incomingRaw &&
							window.__incomingRaw !== "Unknown"
								? window.__incomingRaw
								: window.__incomingDisplay ||
									document.getElementById(
										"incomingCallerNumber",
									).textContent ||
									"Unknown";
						addCallToHistory(
							"incoming",
							num,
							document.getElementById("callDuration")
								.textContent || "00:00",
						);
					}
				} catch (e) {}
				__callDirection = null;
				return __orig_endCall.apply(this, arguments);
			};

			function redial(num) {
				try {
					document.getElementById("callNumber").value = (
						num || ""
					).replace(/[^0-9+]/g, "");
					setView("phone");
					if (typeof makeCall === "function") makeCall();
				} catch (e) {}
				return false;
			}

			// Missed if caller hangs up before answer
			const __orig_setupIncomingSessionHandlers =
				window.setupIncomingSessionHandlers;
			window.setupIncomingSessionHandlers = function (session) {
				__answeredIncoming = false;
				__orig_setupIncomingSessionHandlers.call(this, session);
				try {
					session.on("terminated", () => {
						if (!currentSession && !__answeredIncoming) {
							const num =
								window.__incomingRaw &&
								window.__incomingRaw !== "Unknown"
									? window.__incomingRaw
									: window.__incomingDisplay ||
										document.getElementById(
											"incomingCallerNumber",
										).textContent ||
										"Unknown";
							addCallToHistory("missed", num, "00:00");
						}
					});
				} catch (e) {}
			};
		</script>

		<script>
			/* --- AppStore: save/load SIP config + checkbox prefs (with auto-register) --- */
			(function () {
				if (typeof window.localforage === "undefined") {
					console.warn(
						"localforage not found; AppStore will be disabled.",
					);
					return;
				}
				if (typeof window.CookieStore === "undefined") {
					console.warn(
						"CookieStore not found; AppStore will still attach but encryption may fail.",
					);
				}

				const PREFS_KEY = "uiPrefs";
				const CONFIG_KEY = "sipConfig";

				const AppStore = {
					configKey: CONFIG_KEY,
					prefsKey: PREFS_KEY,

					save: async function () {
						try {
							const el = (id) => document.getElementById(id);
							const saveCredsEl = el("saveCredentials");
							const saveConfigEl = el("saveConfigApp");
							const hideCIDEl = el("hideCallerID");
							const autoRegEl = el("registerOnStartup");

							const prefs = {
								saveCredentials: !!(
									saveCredsEl && saveCredsEl.checked
								),
								saveConfigApp: !!(
									saveConfigEl && saveConfigEl.checked
								),
								hideCallerID: !!(
									hideCIDEl && hideCIDEl.checked
								),
								registerOnStartup: !!(
									autoRegEl && autoRegEl.checked
								),
							};
							await localforage.setItem(this.prefsKey, prefs);

							if (prefs.saveConfigApp) {
								const u = el("username");
								const p = el("password");
								const dn = el("displayName");
								const cid = el("callerID");

								const username = ((u && u.value) || "").trim();
								const passwordRaw = (p && p.value) || "";
								const displayName = (dn && dn.value) || "";
								const callerID = (cid && cid.value) || "";

								if (!isValidUsername(username)) {
									if (window.log)
										log(
											"‚ö†Ô∏è Cannot save app config - username must be exactly 10 digits",
										);
									return;
								}

								try {
									CookieStore &&
										CookieStore.getEncryptionKey &&
										CookieStore.getEncryptionKey();
								} catch (e) {}

								const payload = {
									username: username || "",
									/* password removed from AppStore; stored via SecureStore */
									displayName,
									callerID,
									hideCallerID: prefs.hideCallerID,
									saveCredentials: prefs.saveCredentials,
									saveConfigApp: prefs.saveConfigApp,
									registerOnStartup: prefs.registerOnStartup,
								};

								await localforage.setItem(
									this.configKey,
									payload,
								);
								if (window.log)
									log(
										"SIP configuration saved to app storage",
									);
							} else {
								await localforage.removeItem(this.configKey);
								if (window.log)
									log(
										"SIP configuration removed from app storage",
									);
							}
						} catch (e) {
							console.error("AppStore.save error", e);
							if (window.log)
								log(
									"‚ö†Ô∏è Failed saving SIP configuration or prefs",
								);
						}
					},

					load: async function () {
						try {
							const el = (id) => document.getElementById(id);

							// Load UI prefs
							const prefs =
								(await localforage.getItem(this.prefsKey)) ||
								{};
							if (el("saveCredentials"))
								el("saveCredentials").checked =
									!!prefs.saveCredentials;
							if (el("saveConfigApp"))
								el("saveConfigApp").checked =
									!!prefs.saveConfigApp;
							if (el("hideCallerID"))
								el("hideCallerID").checked =
									!!prefs.hideCallerID;
							if (el("registerOnStartup"))
								el("registerOnStartup").checked =
									!!prefs.registerOnStartup;

							// Load config fields if saved
							const cfg = await localforage.getItem(
								this.configKey,
							);
							if (!cfg) return;

							if (!isValidUsername(cfg.username)) {
								if (window.log)
									log(
										"‚ö†Ô∏è App-stored username failed validation; ignoring saved config",
									);
								await localforage.removeItem(this.configKey);
								return;
							}

							if (el("username") && cfg.username)
								el("username").value = cfg.username;
							if (el("displayName") && cfg.displayName)
								el("displayName").value = cfg.displayName;
							if (el("callerID") && cfg.callerID)
								el("callerID").value = cfg.callerID;

							if (cfg.passwordEnc && el("password")) {
								try {
									CookieStore &&
										CookieStore.getEncryptionKey &&
										CookieStore.getEncryptionKey();
									el("password").value =
										CookieStore && CookieStore.decrypt
											? CookieStore.decrypt(
													cfg.passwordEnc,
												)
											: "";
								} catch (e) {
									console.error(
										"AppStore password decrypt failed",
										e,
									);
									if (window.log)
										log(
											"‚ö†Ô∏è App-stored password decryption failed; clearing app config",
										);
									await localforage.removeItem(
										this.configKey,
									);
								}
							}

							// Apply config prefs
							if (
								typeof cfg.hideCallerID === "boolean" &&
								el("hideCallerID")
							) {
								el("hideCallerID").checked = cfg.hideCallerID;
							}
							if (
								typeof cfg.saveCredentials === "boolean" &&
								el("saveCredentials")
							) {
								el("saveCredentials").checked =
									cfg.saveCredentials;
							}
							if (
								typeof cfg.saveConfigApp === "boolean" &&
								el("saveConfigApp")
							) {
								el("saveConfigApp").checked = cfg.saveConfigApp;
							}
							if (
								typeof cfg.registerOnStartup === "boolean" &&
								el("registerOnStartup")
							) {
								el("registerOnStartup").checked =
									cfg.registerOnStartup;
							}

							if (window.log)
								log(
									"SIP configuration loaded from app storage",
								);
						} catch (e) {
							console.error("AppStore.load error", e);
							if (window.log)
								log(
									"‚ö†Ô∏è Failed loading SIP configuration or prefs",
								);
						}
					},

					clear: async function () {
						try {
							await localforage.removeItem(this.configKey);
							await localforage.removeItem(this.prefsKey);
						} catch (e) {
							console.error("AppStore.clear error", e);
						}
					},
				};
				window.VoiceTelAppStore = AppStore;

				function bindFieldPersistence() {
					const ids = [
						"username",
						"password",
						"displayName",
						"callerID",
						"hideCallerID",
					];
					ids.forEach((id) => {
						const el = document.getElementById(id);
						if (el && !el.__appstoreBound) {
							el.addEventListener("change", function () {
								try {
									const sc =
										document.getElementById(
											"saveCredentials",
										);
									if (
										sc &&
										sc.checked &&
										window.CookieStore &&
										CookieStore.saveCredentials
									) {
										SecureStore.saveCredentials();
									}
								} catch (e) {}
								AppStore.save();
							});
							el.__appstoreBound = true;
						}
					});

					const cbIds = [
						"saveCredentials",
						"saveConfigApp",
						"registerOnStartup",
					];
					cbIds.forEach((id) => {
						const box = document.getElementById(id);
						if (box && !box.__appstoreBound) {
							box.addEventListener("change", function () {
								try {
									if (
										id === "saveCredentials" &&
										window.CookieStore &&
										CookieStore.saveCredentials
									) {
										SecureStore.saveCredentials();
									}
								} catch (e) {}
								AppStore.save();
							});
							box.__appstoreBound = true;
						}
					});
				}

				async function clearAllSaved() {
					const el = (id) => document.getElementById(id);

					// Clear cookies
					try {
						CookieStore &&
							CookieStore.clearAll &&
							CookieStore.clearAll();
					} catch (e) {}

					// Clear app storage
					try {
						await localforage.removeItem(CONFIG_KEY);
						await localforage.removeItem(PREFS_KEY);
						await localforage.removeItem("history");
					} catch (e) {
						console.error("localforage clear error", e);
					}

					// Wipe fields & uncheck boxes
					const fieldIds = [
						"username",
						"password",
						"displayName",
						"callerID",
						"callNumber",
					];
					fieldIds.forEach((id) => {
						const f = el(id);
						if (f) f.value = "";
					});

					const cbIds = [
						"saveConfigApp",
						"saveCredentials",
						"hideCallerID",
						"registerOnStartup",
					];
					cbIds.forEach((id) => {
						const c = el(id);
						if (c) c.checked = false;
					});

					if (typeof renderCallHistory === "function") {
						try {
							renderCallHistory();
						} catch (e) {}
					}
					if (typeof log === "function") {
						log(
							"All saved data cleared (cookies + app storage + prefs). Fields reset.",
						);
					}
				}
				window.clearAllSaved = clearAllSaved;

				function hookRegisterButton() {
					const candidates = Array.from(
						document.querySelectorAll(
							'button, input[type="submit"], a',
						),
					);
					candidates.forEach((el) => {
						if (
							el &&
							typeof el.textContent === "string" &&
							el.textContent.trim().toLowerCase() ===
								"register" &&
							!el.__appstoreRegisterBound
						) {
							el.addEventListener("click", function () {
								AppStore.save();
							});
							el.__appstoreRegisterBound = true;
						}
					});
				}

				window.addEventListener("DOMContentLoaded", function () {
					try {
						AppStore.load();
					} catch (e) {}
					bindFieldPersistence();
					hookRegisterButton();

					// Auto-register on startup if enabled
					try {
						const auto =
							document.getElementById("registerOnStartup");
						const u = document.getElementById("username");
						const p = document.getElementById("password");
						if (
							auto &&
							auto.checked &&
							u &&
							p &&
							isValidUsername(u.value) &&
							p.value
						) {
							if (
								typeof SIP !== "undefined" &&
								typeof register === "function"
							) {
								setTimeout(() => {
									log(
										"Auto-register on startup is enabled ‚Äì attempting registration...",
									);
									register();
								}, 50);
							}
						}
					} catch (e) {

}

					// Keep bindings for dynamically added elements
					const mo = new MutationObserver(() => {
						bindFieldPersistence();
						hookRegisterButton();
					});
					mo.observe(document.body, {
						childList: true,
						subtree: true,
					});
				});
			})();
		</script>
	
<script>
// === SecureStore (AES-GCM + localforage) ‚Äî cookie-free credential storage ===
(function () {
  if (!window.localforage) { console.warn("localforage missing; SecureStore disabled."); return; }
  if (!window.crypto || !window.crypto.subtle) { console.warn("WebCrypto not available; SecureStore disabled."); return; }

  const te = new TextEncoder();
  const td = new TextDecoder();

  function b64e(buf) { return btoa(String.fromCharCode(...new Uint8Array(buf))); }
  function b64d(b64) { const s = atob(b64); const a = new Uint8Array(s.length); for (let i=0;i<s.length;i++) a[i]=s.charCodeAt(i); return a.buffer; }

  function getOrCreateSalt() {
    const k = "vt_aesgcm_salt";
    let v = localStorage.getItem(k);
    if (!v) { v = b64e(crypto.getRandomValues(new Uint8Array(16))); localStorage.setItem(k, v); }
    return b64d(v);
  }

  // Basic device fingerprint (stable per browser profile)
  function deviceFingerprint() {
    try {
      const tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || "");
      const langs = (navigator.languages || []).join(",");
      const dims = (screen ? (screen.width + "x" + screen.height) : "");
      return [navigator.userAgent, navigator.platform||"", tz, langs, dims].join("|");
    } catch(e) { return navigator.userAgent || "voicetel-default"; }
  }

  async function deriveKey(secret, iterations = 150000) {
    const base = await crypto.subtle.importKey("raw", te.encode(secret), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt: getOrCreateSalt(), iterations, hash: "SHA-256" },
      base, { name: "AES-GCM", length: 256 }, false, ["encrypt","decrypt"]
    );
  }

  async function encryptJSON(key, obj) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const pt = te.encode(JSON.stringify(obj));
    const ct = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, pt);
    return { v: 1, iv: b64e(iv), ct: b64e(ct) };
  }

  async function decryptJSON(key, payload) {
    const iv = new Uint8Array(b64d(payload.iv));
    const ct = b64d(payload.ct);
    const pt = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, ct);
    return JSON.parse(td.decode(pt));
  }

  const STORAGE_KEY = "vt.secure.credentials";

  window.SecureStore = {
    async saveCredentials(creds) {
      const key = await deriveKey(deviceFingerprint());
      const enc = await encryptJSON(key, creds);
      await localforage.setItem(STORAGE_KEY, enc);
      return true;
    },
    async loadCredentials() {
      const payload = await localforage.getItem(STORAGE_KEY);
      if (!payload) return null;
      try {
        const key = await deriveKey(deviceFingerprint());
        return await decryptJSON(key, payload);
      } catch(e) {
        console.warn("SecureStore decrypt failed", e);
        return null;
      }
    },
    async clear() {
      await localforage.removeItem(STORAGE_KEY);
    }
  };
})();
</script>


<script>
// Persist credentials from form if "Remember me" is checked
async function persistCredentialsFromUI() {
  try {
    const remember = document.getElementById("saveCredentials");
    if (remember && remember.checked && window.SecureStore) {
      const server = (document.getElementById("sipServer") || document.getElementById("server"))?.value || "";
      const username = document.getElementById("username")?.value || "";
      const displayName = document.getElementById("displayName")?.value || "";
      const callerID = document.getElementById("callerID")?.value || "";
      const password = document.getElementById("password")?.value || "";
      await SecureStore.saveCredentials({ server, username, displayName, callerID, password });
    }
  } catch(e) { console.warn("Secure persist failed", e); }
}

// On startup, try to autofill from SecureStore
document.addEventListener("DOMContentLoaded", async () => {
  try {
    if (window.SecureStore) {
      const restored = await SecureStore.loadCredentials();
      if (restored) {
        const sid = (document.getElementById("sipServer") || document.getElementById("server"));
        if (sid) sid.value = restored.server || sid.value || "";
        const un = document.getElementById("username"); if (un) un.value = restored.username || un.value || "";
        const dn = document.getElementById("displayName"); if (dn) dn.value = restored.displayName || dn.value || "";
        const cid = document.getElementById("callerID"); if (cid) cid.value = restored.callerID || cid.value || "";
        const pw = document.getElementById("password"); if (pw) pw.value = restored.password || "";
        const remember = document.getElementById("saveCredentials"); if (remember) remember.checked = true;
      }
    }
  } catch(e) { console.warn("Secure autofill failed", e); }
});
</script>

</body>
</html>